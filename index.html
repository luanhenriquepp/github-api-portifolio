<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Potifólio</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <h1>Portifólio</h1>
  <div>
    <form id="form">
      <input type="text" required placeholder="LOGIN GITHUB">
      <button type="submit">
        Buscar usuário
      </button>
    </form>
  </div>
  <div class="container">
    <div id="bio" class="bio">
      <img id="avatar" />
      <h2 id="about"></h2>
      <p id="bio_pagraph"></p>
    </div>
    <div id="render-list" class="render-list">
    </div>
  </div>

  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.js"></script>

  <script>

    const baseUrl = 'https://api.github.com'

    const getUserProjects = repos_url => {
      
      document.getElementById('render-list').innerHTML = ''
      axios.get(repos_url).then(response => {

        response.data.forEach(element => {
          axios.get(element.languages_url).then(resp => {

            const resultCalc = calculateTechs(resp.data)
            const canvas = createChart(resp.data, resultCalc);

            const newElement = element.name.replace(new RegExp(/\W+/g), ' ')
            const nameCapitalized = newElement.charAt(0).toUpperCase() + newElement.slice(1)

            const divCardElement = document.createElement('div')
            divCardElement.setAttribute('class', 'card')
            const h2Element = document.createElement('h2')
            h2Element.innerHTML = nameCapitalized
            divCardElement.appendChild(h2Element)

            const pElementDescription = document.createElement('p')
            pElementDescription.innerHTML = element.description
            divCardElement.appendChild(pElementDescription)

            const aElement = document.createElement('a')
            aElement.setAttribute('href', element.html_url)
            aElement.target = '_blank'
            aElement.innerHTML = 'LINK DO PROJETO'
            divCardElement.appendChild(aElement)
            divCardElement.appendChild(canvas)

            document.getElementById('render-list').appendChild(divCardElement);
          })
        })
      })
    }

    const calculateTechs = params => {
      const total = Object.values(params).reduce((accumulator, currentValue) => accumulator + currentValue, 0)
      return Object.keys(params).map(item => {
        const percentage = (params[item] / total) * 100
        return percentage.toFixed(2)
      })
    }

    const createChart  = (params, calculatedvalues) => {
      const elementCanvas = document.createElement('canvas')
      const oilData = {
        labels: Object.keys(params),
        datasets: [
          {
            data: calculatedvalues,
            backgroundColor: [
              "#FF6384",
              "#63FF84",
              "#84FF63",
              "#8463FF",
              "#6384FF"
            ]
          }]
      }
      new Chart(elementCanvas, {
        type: 'pie',
        data: oilData
      });
      return elementCanvas;
    }

    const setUserInformation = user => {
      const avatar_url = document.getElementById('avatar')
      avatar_url.src = user.avatar_url
      document.getElementById('about').innerHTML = 'Sobre mim'
      document.getElementById('bio_pagraph').innerHTML = user.bio
      getUserProjects(user.repos_url)
    }

    const getUser = login => {
      axios.get(`${baseUrl}/users/${login}`).then(response => {
        setUserInformation(response.data)
      }).catch(error => {
        if (error.response.status === 404) {
          return alert('Usuário não encontrado')
        }
      })
    }

    document.querySelector('#form').addEventListener('submit', event => {
      const user = event.target[0].value
      event.preventDefault();
      getUser(user)
    })

  </script>
</body>

</html>